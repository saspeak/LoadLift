configfile: "UCE-config.yaml"

def get_input_genome(wildcards):
    return config["individuals"][wildcards.individual]

rule make_2bit:
    input:
        individual=get_input_genome 
    output:
        "{individual}/{individual}.2bit"
    params:
        genome_path=config["genome_path"]
    shell:
        "fa2twobit {params.genome_path}/{output}"


rule phyluce_probe_run_multiple_lastzs_sqlite:
    input:
        genome_path=config["genome_path"],
        probes=config["probe_file"]
    output:
        "{individual}-genome-lastz"
    params:
        cores="12",
        individual="{individual}" 
    shell:
        "phyluce_probe_run_multiple_lastzs_sqlite --db {individual}.sqlite --output {output} --scaffoldlist {params.individual} --genome-base-path {input.genome_path} --probefile {input.probes} --cores  {params.cores}"

rule make_conf_file:
    input:
        genome_path=config["genome_path"]
    output:
        conf=config["config_file"]
    params:
        individual="{individual}"
    shell:
        "echo {params.individual}:{input.genome_path}/{params.individual}/{params.individual}.2bit > {output.conf}"

rule phyluce_probe_slice_sequence_from_genomes:
    input:
        lastz="{individual}-genome-lastz/",
        conf=config["config_file"]
    output:
        "{individual}.fasta"
    params:
        name="uce-5k-probes.{individual}.lastz.clean",
        dir=config["out_dir"],
        flank=config["flank-size"]
    shell:
        "phyluce_probe_slice_sequence_from_genomes --lastz {input.lastz} --conf {input.conf} --flank {params.flank} --name-pattern {params.name} --output {params.dir}"

rule orientation_lables:
    input:
        "{individual}.fasta"
    output:
        "UCE_regions/{individual}_UCE_regions.txt"
    params:
        columns="-f 2,3,4,6",
        orient=config["params_orientation"]
    shell:
        "grep 'uce' {input} | cut -d '|' {params.columns} | sed -e 's/|/\t/g' | sed -e 's/contig://g' | sed -e 's/slice://g'| sed -e 's/uce://g' | sed -e 's/orient://g' | sed -e 's/uce-/uce_/g' | {params.orient}| sed -e 's/-/\t/g'  > {output}"

rule orientation_separation_forward:
    input:
        "UCE_regions/{individual}_UCE_regions.txt"
    output:
        "UCE_regions/forward/{individual}_UCE_forward_orient_regions.txt"
    params:
        "-f 1,2,3"
    shell:
        "grep 'forward' {input}| cut {params} > {output}"

rule orientation_separation_reverse:
    input:
        "UCE_regions/{individual}_UCE_regions.txt"
    output:
        "UCE_regions/reverse{individual}_UCE_reverse_orient_regions.txt"
    params:
        "-f 1,2,3"
    shell:
        "grep 'reverse' {input}| cut {params} > {output}"
